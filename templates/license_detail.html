<!DOCTYPE html>
<html lang="pl">
<head>
    <title>Licencja {{ lic.license_key[:8] }}â€¦ â€” ThunderT Admin</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --thundert-yellow: #FFD700;
            --thundert-yellow-hover: #e6c200;
            --thundert-purple: #ab47bc;
            --thundert-purple-light: #ce93d8;
            --thundert-green: #00c853;
            --thundert-blue: #2196F3;
            --thundert-red: #f44336;
            --thundert-bg: #0a0a0a;
            --thundert-card: #111;
            --thundert-border: #333;
        }
        body { background: var(--thundert-bg); color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; }
        .card { background: var(--thundert-card); border: 1px solid var(--thundert-border); margin-bottom: 20px; }
        h1, h2, h5 { color: var(--thundert-yellow); text-transform: uppercase; letter-spacing: 1px; }
        .section-title { color: var(--thundert-yellow); border-bottom: 2px solid var(--thundert-yellow); padding-bottom: 0.35rem; margin-bottom: 1rem; display: inline-block; }
        .btn-gold { background: var(--thundert-yellow); color: #000; border: none; font-weight: bold; }
        .btn-gold:hover { background: var(--thundert-yellow-hover); color: #000; }
        
        /* Pixelated/digital font for action buttons */
        @font-face {
            font-family: 'Digital';
            src: local('Courier New'), local('monospace');
        }
        
        .btn-action {
            background: transparent !important;
            border: 1px solid;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 4px 12px;
            transition: all 0.2s;
        }
        .btn-action:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        .btn-edit { 
            color: #00ffff !important; 
            border-color: #00ffff !important; 
            background: transparent !important;
        }
        .btn-edit:hover { 
            color: #00ffff !important; 
            border-color: #00ffff !important;
            background: rgba(0, 255, 255, 0.1) !important;
        }
        .btn-reset { 
            color: #00ffff !important; 
            border-color: #00ffff !important; 
            background: transparent !important;
            font-size: 16px;
            padding: 4px 10px;
        }
        .btn-reset:hover { 
            color: #00ffff !important; 
            border-color: #00ffff !important;
            background: rgba(0, 255, 255, 0.1) !important;
        }
        .btn-ban { 
            color: #FFD700 !important; 
            border-color: #FFD700 !important; 
            background: transparent !important;
        }
        .btn-ban:hover { 
            color: #FFD700 !important; 
            border-color: #FFD700 !important;
            background: rgba(255, 215, 0, 0.1) !important;
        }
        .btn-delete { 
            color: #f44336 !important; 
            border-color: #f44336 !important; 
            background: transparent !important;
            font-size: 18px;
            font-weight: bold;
            padding: 4px 10px;
        }
        .btn-delete:hover { 
            color: #f44336 !important; 
            border-color: #f44336 !important;
            background: rgba(244, 67, 54, 0.1) !important;
        }
        .table-dark { background-color: var(--thundert-card); --bs-table-bg: var(--thundert-card); border-color: var(--thundert-border); }
        th { color: var(--thundert-yellow) !important; border-bottom: 2px solid var(--thundert-yellow) !important; }
        .badge-basic { background: rgba(158, 158, 158, 0.25); border: 1px solid #9e9e9e; color: var(--thundert-purple-light); }
        .badge-pro { background: rgba(171, 71, 188, 0.25); border: 1px solid var(--thundert-purple); color: var(--thundert-purple); }
        .badge-enterprise { background: rgba(213, 0, 249, 0.2); border: 1px solid #d500f9; color: #d500f9; }
        .status-active { color: var(--thundert-green); font-weight: 600; }
        .status-expired { color: #ff9800; }
        .status-banned { color: var(--thundert-red); text-decoration: line-through; }
        .info-row { display: flex; padding: 0.4rem 0; border-bottom: 1px solid #222; }
        .info-label { color: #b8b8b8; min-width: 180px; }
        .text-muted { color: #b8b8b8 !important; }
        .text-secondary-bright { color: #b8b8b8 !important; }
        .info-value { color: #e0e0e0; word-break: break-all; }
        .log-critical { background: rgba(244, 67, 54, 0.1); border-left: 3px solid var(--thundert-red); }
        .log-warning { border-left: 3px solid #ff9800; }
        a { color: var(--thundert-yellow); }
        a:hover { color: var(--thundert-yellow-hover); }
        .mono { font-family: 'Consolas', 'Courier New', monospace; }
        .empty-hint { font-style: italic; }
    </style>
</head>
<body>
    <div class="container-fluid" style="max-width: 1200px;">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
            <div>
                <h1 class="mb-0">âš¡ ThunderT Manager â€” SzczegÃ³Å‚y licencji</h1>
                <small class="text-secondary-bright">Admin ID: {{ admin_id }}</small>
            </div>
            <div>
                <a href="/" class="btn btn-outline-secondary btn-sm me-2">DASHBOARD</a>
                <a href="/stats" class="btn btn-outline-secondary btn-sm me-2">STATYSTYKI</a>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">WYLOGUJ</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} py-2">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-lg-6">
                <div class="card p-4">
                    <h5 class="section-title mb-3">Dane licencji</h5>
                    <div class="info-row">
                        <span class="info-label">Klucz</span>
                        <span class="info-value mono">{{ lic.license_key }}
                            <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-secondary-bright copy-key" title="Kopiuj" data-key="{{ lic.license_key }}">ðŸ“‹</button>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Typ</span>
                        <span class="info-value"><span class="badge badge-{{ (lic.license_type or 'basic').lower() }}">{{ lic.license_type or 'BASIC' }}</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value">
                            {% if lic.status == 'banned' %}<span class="status-banned">BANNED</span>
                            {% elif lic.is_expired or lic.status == 'expired' %}<span class="status-expired">EXPIRED</span>
                            {% else %}<span class="status-active">AKTYWNY</span>{% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Notatka</span>
                        <span class="info-value">{{ lic.note or 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Telegram</span>
                        <span class="info-value">{% if lic.telegram_username %}@{{ (lic.telegram_username or '') | replace('@','') }}{% else %}â€”{% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Wygasa</span>
                        <span class="info-value">{% if lic.expires_at %}{{ lic.expires_at[:19] }}{% else %}âˆž (lifetime){% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Utworzona</span>
                        <span class="info-value">{{ (lic.created_at or '')[:19] or 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Max telefonÃ³w</span>
                        <span class="info-value">{{ lic.max_phones | default(1) }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">HWID (legacy)</span>
                        <span class="info-value mono small">{{ lic.hwid or 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ostatni heartbeat</span>
                        <span class="info-value">{{ (lic.last_seen or 'â€”')[:19] if lic.last_seen else 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ostatnie IP</span>
                        <span class="info-value">{{ lic.last_ip or 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Wersja aplikacji</span>
                        <span class="info-value">{{ lic.last_app_version or 'â€”' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">User-Agent</span>
                        <span class="info-value small text-secondary-bright" style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">{{ lic.last_user_agent or 'â€”' }}</span>
                    </div>
                </div>
            </div>

                <div class="col-lg-6">
                <div class="card p-4">
                    <h5 class="section-title mb-3">Edytuj licencjÄ™</h5>
                    <form action="{{ url_for('license_update', license_id=lic.id) }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label text-secondary-bright">Notatka</label>
                            <input type="text" name="note" class="form-control bg-dark text-white border-secondary" value="{{ lic.note or '' }}" placeholder="Dla kogo?">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary-bright">Telegram</label>
                            <input type="text" name="telegram_username" class="form-control bg-dark text-white border-secondary" value="{{ lic.telegram_username or '' }}" placeholder="@username">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label text-secondary-bright">Typ</label>
                                <select name="license_type" class="form-select bg-dark text-white border-secondary">
                                    <option value="BASIC" {{ 'selected' if (lic.license_type or '').upper() == 'BASIC' else '' }}>BASIC</option>
                                    <option value="PRO" {{ 'selected' if (lic.license_type or 'PRO').upper() == 'PRO' else '' }}>PRO</option>
                                    <option value="ENTERPRISE" {{ 'selected' if (lic.license_type or '').upper() == 'ENTERPRISE' else '' }}>ENTERPRISE</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label text-secondary-bright">Status</label>
                                <select name="status" class="form-select bg-dark text-white border-secondary">
                                    <option value="active" {{ 'selected' if (lic.status or 'active') == 'active' else '' }}>active</option>
                                    <option value="banned" {{ 'selected' if lic.status == 'banned' else '' }}>banned</option>
                                    <option value="expired" {{ 'selected' if lic.status == 'expired' else '' }}>expired</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label text-secondary-bright">Max telefonÃ³w</label>
                                <input type="number" name="max_phones" class="form-control bg-dark text-white border-secondary" value="{{ lic.max_phones | default(1) }}" min="1" max="99">
                            </div>
                            <div class="col-6">
                                <label class="form-label text-secondary-bright">PrzedÅ‚uÅ¼ o (dni)</label>
                                <select name="extend_days" class="form-select bg-dark text-white border-secondary">
                                    <option value="0" selected>Nie przedÅ‚uÅ¼aj</option>
                                    <option value="1">+1 dzieÅ„</option>
                                    <option value="7">+7 dni</option>
                                    <option value="30">+30 dni</option>
                                    <option value="90">+90 dni</option>
                                    <option value="365">+1 rok</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary-bright">Ustaw datÄ™ wygaÅ›niÄ™cia (opcjonalnie)</label>
                            <input type="datetime-local" name="expires_at" class="form-control bg-dark text-white border-secondary" value="{{ (lic.expires_at or '')[:19].replace(' ', 'T')[:16] if lic.expires_at else '' }}" placeholder="Puste = bez zmiany">
                        </div>
                        <button type="submit" class="btn btn-gold w-100">Zapisz zmiany</button>
                    </form>

                    <hr class="border-secondary my-4">
                    <h6 class="text-uppercase text-secondary-bright mb-2">Akcje</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% set redirect_url = url_for('license_detail', license_id=lic.id) %}
                        {% if lic.hwid %}
                        <form action="/action/reset_hwid/{{ lic.id }}" method="POST" class="d-inline">
                            <input type="hidden" name="redirect" value="{{ redirect_url }}">
                            <button type="submit" class="btn btn-sm btn-action btn-reset">â™»</button>
                        </form>
                        {% endif %}
                        <form action="/action/reset_devices/{{ lic.id }}" method="POST" class="d-inline">
                            <input type="hidden" name="redirect" value="{{ redirect_url }}">
                            <button type="submit" class="btn btn-sm btn-action btn-reset" onclick="return confirm('ZresetowaÄ‡ urzÄ…dzenia i sesje?')">â™»</button>
                        </form>
                        {% if lic.status == 'banned' %}
                        <form action="/action/unban/{{ lic.id }}" method="POST" class="d-inline">
                            <input type="hidden" name="redirect" value="{{ redirect_url }}">
                            <button type="submit" class="btn btn-sm btn-action btn-ban">UNBAN</button>
                        </form>
                        {% else %}
                        <form action="/action/ban/{{ lic.id }}" method="POST" class="d-inline">
                            <input type="hidden" name="redirect" value="{{ redirect_url }}">
                            <button type="submit" class="btn btn-sm btn-action btn-ban" onclick="return confirm('ZbanowaÄ‡ licencjÄ™?')">BAN</button>
                        </form>
                        {% endif %}
                        <form action="/action/delete/{{ lic.id }}" method="POST" class="d-inline" onsubmit="return confirm('Na pewno usunÄ…Ä‡ licencjÄ™?');">
                            <button type="submit" class="btn btn-sm btn-action btn-delete">X</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-12">
                <div class="card p-3">
                    <h5 class="section-title mb-3">UrzÄ…dzenia ({{ devices | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>HWID</th>
                                    <th>Status</th>
                                    <th>Pierwsze seen</th>
                                    <th>Ostatnie seen</th>
                                    <th>IP</th>
                                    <th>Wersja</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in devices %}
                                <tr>
                                    <td class="mono small">{{ d.hwid }}</td>
                                    <td><span class="badge {{ 'bg-danger' if d.status == 'banned' else 'bg-success' }}">{{ d.status }}</span></td>
                                    <td class="small text-secondary-bright">{{ (d.first_seen or 'â€”')[:19] }}</td>
                                    <td class="small text-secondary-bright">{{ (d.last_seen or 'â€”')[:19] }}</td>
                                    <td>{{ d.last_ip or 'â€”' }}</td>
                                    <td>{{ d.app_version or 'â€”' }}</td>
                                </tr>
                                {% endfor %}
                                {% if not devices %}
                                <tr><td colspan="6" class="text-secondary-bright empty-hint">Brak urzÄ…dzeÅ„ (lub tryb legacy HWID)</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-lg-6">
                <div class="card p-3">
                    <h5 class="section-title mb-3">Sesje ({{ sessions | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Status</th>
                                    <th>Ostatnie seen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in sessions %}
                                <tr>
                                    <td class="mono small">{{ s.id[:8] }}â€¦</td>
                                    <td><span class="badge bg-secondary">{{ s.status }}</span></td>
                                    <td class="small text-secondary-bright">{{ (s.last_seen or 'â€”')[:19] }}</td>
                                </tr>
                                {% endfor %}
                                {% if not sessions %}
                                <tr><td colspan="3" class="text-secondary-bright empty-hint">Brak sesji</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-3">
                    <h5 class="section-title mb-3">Ostatnie logi ({{ logs | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Czas</th>
                                    <th>Severity</th>
                                    <th>WiadomoÅ›Ä‡</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="log-{{ log.severity }}">
                                    <td class="small text-secondary-bright">{{ (log.created_at or '')[:19] }}</td>
                                    <td class="text-uppercase small {{ 'text-danger' if log.severity == 'critical' else 'text-warning' if log.severity == 'warning' else '' }}">{{ log.severity }}</td>
                                    <td class="small">{{ log.message }} {% if log.hwid_attempt %}<br><span class="text-secondary-bright">HWID: {{ log.hwid_attempt }}</span>{% endif %}</td>
                                    <td class="small">{{ log.ip_address }}</td>
                                </tr>
                                {% endfor %}
                                {% if not logs %}
                                <tr><td colspan="4" class="text-secondary-bright empty-hint">Brak logÃ³w</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.querySelectorAll('.copy-key').forEach(function (btn) {
    btn.addEventListener('click', function () {
        var key = this.dataset.key;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(key).then(function () {
                var t = btn.textContent; btn.textContent = 'âœ“'; setTimeout(function () { btn.textContent = t; }, 800);
            });
        }
    });
});
    </script>
</body>
</html>
